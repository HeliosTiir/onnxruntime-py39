name: Build ONNX Runtime ROCm 7.1 for Python 3.9

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: rocm/dev-ubuntu-22.04:7.1.1-complete
    steps:
      - name: Checkout ONNX Runtime
        uses: actions/checkout@v3

      - name: Setup Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Install Python build dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel cmake ninja numpy==1.26.1

      - name: Setup ROCm environment
        run: |
          export ROCM_PATH=/opt/rocm
          export HIP_PATH=$ROCM_PATH/hip
          export PATH=$ROCM_PATH/bin:$PATH
          export LD_LIBRARY_PATH=$ROCM_PATH/lib:$ROCM_PATH/lib64:$LD_LIBRARY_PATH
          export HSA_OVERRIDE_GFX_VERSION=10.3.0

      - name: Build ONNX Runtime
        run: |
          mkdir -p build && cd build
          cmake ../ \
            -Donnxruntime_ENABLE_PYTHON=ON \
            -DPYTHON_EXECUTABLE=$(which python) \
            -Donnxruntime_USE_ROCM=ON \
            -Donnxruntime_USE_MIGRAPHX=ON \
            -Donnxruntime_BUILD_SHARED_LIB=ON \
            -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)

      - name: Build Python wheel
        run: |
          cd ..
          python setup.py bdist_wheel

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: onnxruntime-rocm-wheel
          path: dist/*.whl
