name: Build ONNX Runtime ROCm 7.1 for Python 3.9

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: rocm/dev-ubuntu-22.04:7.1.1
      options: --user root

    steps:
      - name: Install Git and System Python Deps
        run: |
          apt-get update -y
          apt-get install -y git python3-pip
          
          # Install deps for the SYSTEM python (3.10) which runs the build script
          # We need 'packaging' and 'flatbuffers' here so build.py doesn't crash
          /usr/bin/python3 -m pip install packaging flatbuffers

      - name: Checkout ONNX Runtime
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Python 3.9 (Target)
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Trust Git Directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Install Target Python Dependencies
        run: |
          # Install dependencies for the TARGET Python (3.9)
          # We need numpy here so we can link against it
          python -m pip install --upgrade pip setuptools wheel cmake ninja numpy==1.26.1 packaging

      - name: Build ONNX Runtime and Wheel
        env:
          ROCM_PATH: /opt/rocm
          HIP_PATH: /opt/rocm/hip
          HSA_OVERRIDE_GFX_VERSION: 10.3.0
        run: |
          # 1. Capture Target Python Paths
          PY39_EXE=$(which python)
          
          # Calculate exact numpy include path for Python 3.9
          PY39_NUMPY_INC=$(python -c "import numpy; print(numpy.get_include())")
          
          echo "Target Python: $PY39_EXE"
          echo "Target NumPy: $PY39_NUMPY_INC"

          # 2. Run Build Script
          # We use System Python (3.10) to run the script (to support new syntax)
          # But we pass CMake flags to FORCE it to link against Python 3.9
          
          /usr/bin/python3 tools/ci_build/build.py \
            --build_dir build \
            --config Release \
            --update \
            --build \
            --build_wheel \
            --parallel $(nproc) \
            --skip_submodule_sync \
            --allow_running_as_root \
            --cmake_extra_defines \
                onnxruntime_USE_ROCM=ON \
                onnxruntime_ROCM_HOME=/opt/rocm \
                onnxruntime_USE_MIGRAPHX=ON \
                CMAKE_HIP_ARCHITECTURES=gfx90a,gfx908,gfx1030 \
                Python_EXECUTABLE=$PY39_EXE \
                Python_NumPy_INCLUDE_DIRS=$PY39_NUMPY_INC

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: onnxruntime-rocm-wheel
          path: build/Release/dist/*.whl
