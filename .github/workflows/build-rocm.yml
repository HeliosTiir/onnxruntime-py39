name: Build ONNX Runtime ROCm 7.1 for Python 3.9

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: rocm/dev-ubuntu-22.04:7.1.1
      options: --user root

    steps:
      - name: Install System Dependencies
        run: |
          apt-get update -y
          apt-get install -y git python3-pip migraphx
          /usr/bin/python3 -m pip install packaging flatbuffers

      - name: Checkout ONNX Runtime
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0

      # --- NEW: CACHE STEP ---
      # This saves the 'build' folder. If you re-run this workflow later,
      # it restores the compiled files so you don't have to compile again.
      - name: Cache Build Directory
        id: cache-build
        uses: actions/cache@v3
        with:
          path: build
          # Cache key based on commit hash. If commit hasn't changed, we reuse the build.
          key: onnxruntime-build-${{ github.sha }}

      - name: Patch CMake for Python 3.9
        run: |
          echo "Patching CMakeLists.txt to allow Python 3.9..."
          grep -rl "find_package(Python 3.10" . | xargs sed -i 's/find_package(Python 3.10/find_package(Python 3.9/g' || true
          sed -i 's/3\.10/3.9/g' cmake/CMakeLists.txt || true

      - name: Setup Python 3.9 (Target)
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Trust Git Directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Install Target Python Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel cmake ninja numpy==1.26.1 packaging

      # --- COMPILE STEP (SKIPPED IF CACHED) ---
      - name: Compile ONNX Runtime (C++ Only)
        if: steps.cache-build.outputs.cache-hit != 'true'
        env:
          ROCM_PATH: /opt/rocm
          HIP_PATH: /opt/rocm/hip
          HSA_OVERRIDE_GFX_VERSION: 10.3.0
        run: |
          PY39_EXE=$(which python)
          PY39_NUMPY_INC=$(python -c "import numpy; print(numpy.get_include())")
          
          # Compile using System Python (3.10) but linking to Target Python (3.9)
          /usr/bin/python3 tools/ci_build/build.py \
            --build_dir build \
            --config Release \
            --update \
            --build \
            --parallel $(nproc) \
            --skip_submodule_sync \
            --allow_running_as_root \
            --cmake_extra_defines \
                onnxruntime_USE_ROCM=ON \
                onnxruntime_ROCM_HOME=/opt/rocm \
                onnxruntime_USE_MIGRAPHX=ON \
                CMAKE_HIP_ARCHITECTURES=gfx90a,gfx908,gfx1030 \
                Python_EXECUTABLE=$PY39_EXE \
                Python_NumPy_INCLUDE_DIRS=$PY39_NUMPY_INC

      # --- STAGING & PACKAGING (FIXED README ERROR) ---
      - name: Stage Files and Build Wheel
        run: |
          echo "Staging files for wheel build..."
          
          BUILD_ROOT="build/Release"
          DEST_PKG="$BUILD_ROOT/onnxruntime"
          DEST_CAPI="$DEST_PKG/capi"
          
          # 1. Copy Source & Setup
          cp -r onnxruntime "$BUILD_ROOT/"
          cp setup.py "$BUILD_ROOT/"
          
          # 2. FIX: Smart README handling
          # setup.py demands README.rst. Most repos have README.md.
          if [ -f "README.rst" ]; then
             cp README.rst "$BUILD_ROOT/"
          elif [ -f "README.md" ]; then
             echo "Converting README.md to README.rst for setup.py"
             cp README.md "$BUILD_ROOT/README.rst"
          else
             echo "No README found, creating dummy file."
             touch "$BUILD_ROOT/README.rst"
          fi
          
          # Copy LICENSE if it exists, otherwise ignore
          cp LICENSE "$BUILD_ROOT/" || true
          
          # 3. Ensure destination exists and copy binaries
          mkdir -p "$DEST_CAPI"
          echo "Copying binaries to $DEST_CAPI..."
          
          # Copy pybind state (try both locations)
          find "$BUILD_ROOT" -name "onnxruntime_pybind11_state.so" -exec cp {} "$DEST_CAPI/" \;
          
          # Copy shared libraries
          find "$BUILD_ROOT" -maxdepth 1 -name "*.so*" -exec cp {} "$DEST_CAPI/" \;
          
          # 4. Build Wheel
          cd "$BUILD_ROOT"
          echo "Building Wheel for Python 3.9..."
          python setup.py bdist_wheel \
            --use_rocm \
            --use_migraphx \
            --dist-dir dist

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: onnxruntime-rocm-wheel
          path: build/Release/dist/*.whl
