name: Build ONNX Runtime ROCm 7.1 for Python 3.9

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: rocm/dev-ubuntu-22.04:7.1.1
      options: --user root

    steps:
      - name: Install System Dependencies
        run: |
          apt-get update -y
          apt-get install -y git python3-pip migraphx
          /usr/bin/python3 -m pip install packaging flatbuffers

      - name: Checkout ONNX Runtime
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0

      # RESTORE CACHE (v4)
      - name: Restore Build Cache
        id: restore-build
        uses: actions/cache/restore@v3
        with:
          path: build
          key: onnx-rocm-build-v4

      - name: Patch CMake and Setup for Python 3.9
        run: |
          # Patch CMake to accept Py3.9
          grep -rl "find_package(Python 3.10" . | xargs sed -i 's/find_package(Python 3.10/find_package(Python 3.9/g' || true
          sed -i 's/3\.10/3.9/g' cmake/CMakeLists.txt || true
          
          # Patch setup.py metadata
          sed -i 's/python_requires=">=3.10"/python_requires=">=3.9"/g' setup.py || true
          sed -i 's/>=3.10/>=3.9/g' setup.py || true

      - name: Setup Python 3.9 (Target)
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Trust Git Directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Install Target Python Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel cmake ninja numpy==1.26.1 packaging

      # COMPILE (Skipped if cache hits)
      - name: Compile ONNX Runtime (C++ Only)
        if: steps.restore-build.outputs.cache-hit != 'true'
        env:
          ROCM_PATH: /opt/rocm
          HIP_PATH: /opt/rocm/hip
          HSA_OVERRIDE_GFX_VERSION: 10.3.0
        run: |
          PY39_EXE=$(which python)
          PY39_NUMPY_INC=$(python -c "import numpy; print(numpy.get_include())")
          
          /usr/bin/python3 tools/ci_build/build.py \
            --build_dir build \
            --config Release \
            --update \
            --build \
            --parallel $(nproc) \
            --skip_submodule_sync \
            --allow_running_as_root \
            --cmake_extra_defines \
                onnxruntime_ENABLE_PYTHON=ON \
                onnxruntime_USE_ROCM=ON \
                onnxruntime_ROCM_HOME=/opt/rocm \
                onnxruntime_USE_MIGRAPHX=ON \
                CMAKE_HIP_ARCHITECTURES=gfx90a,gfx908,gfx1030 \
                Python_EXECUTABLE=$PY39_EXE \
                Python_NumPy_INCLUDE_DIRS=$PY39_NUMPY_INC \
                CMAKE_SHARED_LINKER_FLAGS=-Wl,-z,noexecstack \
                CMAKE_MODULE_LINKER_FLAGS=-Wl,-z,noexecstack

      - name: Save Build Cache
        if: steps.restore-build.outputs.cache-hit != 'true'
        uses: actions/cache/save@v3
        with:
          path: build
          key: onnx-rocm-build-v4

      - name: Prepare Workspace and Build Wheel
        env:
          ONNXRUNTIME_USE_ROCM: 1
          ONNXRUNTIME_USE_MIGRAPHX: 1
          ONNXRUNTIME_ROCM_VERSION: 7.1
        run: |
          if [ ! -f "README.rst" ]; then
             cp README.md README.rst || echo "ONNX Runtime" > README.rst
          fi

          echo "Replacing source 'onnxruntime' folder with generated package..."
          mv onnxruntime onnxruntime_cpp_source
          cp -r build/Release/onnxruntime .
          
          echo "Injecting binaries..."
          DEST_CAPI="onnxruntime/capi"
          mkdir -p "$DEST_CAPI"
          find build/Release -maxdepth 1 -name "*.so*" -exec cp -v {} "$DEST_CAPI/" \;
          find build/Release -name "*onnxruntime_pybind11_state*.so" -exec cp -v {} "$DEST_CAPI/" \;
          
          echo "Copying build helper scripts..."
          find . -name "onnxruntime_collect_build_info.py" -exec cp -v {} . \;

          # --- CRITICAL FIX: Bulk Patch Python 3.10 Syntax for Python 3.9 ---
          echo "Sanitizing Python code for 3.9 compatibility..."
          
          # 1. Add __future__ annotations to all python files (helps with type hints)
          # We skip empty files or files that already have it.
          find onnxruntime -name "*.py" -exec sed -i '1i from __future__ import annotations' {} \;
          
          # 2. Bulk remove "| None" which crashes Py3.9 (e.g., "str | None" -> "str")
          # This is safe for type hints and fixes the "unsupported operand" error.
          grep -rl " | None" onnxruntime | xargs sed -i 's/ | None//g'
          
          # 3. Handle other Union types "TypeA | TypeB" -> "Union[TypeA, TypeB]" is hard with sed.
          # But usually the crash is caused by " | None" in default arguments.
          # We will also try to catch simple "int | str" cases if they exist by blindly removing pipes in type hints.
          # (This is aggressive but necessary without a full refactor)
          
          echo "Sanitization complete."

          # 5. Build Wheel
          echo "Building Wheel..."
          python setup.py bdist_wheel --dist-dir dist

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: onnxruntime-rocm-wheel
          path: dist/*.whl
