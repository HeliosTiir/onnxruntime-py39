name: Build ONNX Runtime ROCm 7.1 for Python 3.9

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: rocm/dev-ubuntu-22.04:7.1.1
      # Docker often runs as a specific user, ensure we have root for installing pip pkgs
      options: --user root 

    steps:
      - name: Checkout ONNX Runtime
        uses: actions/checkout@v3
        with:
          # CRITICAL: ONNX Runtime dependencies live in submodules
          submodules: recursive 
          fetch-depth: 0

      - name: Setup Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Trust Git Directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Install Python build dependencies
        run: |
          # 'packaging' and 'wheel' are required for the build script
          python -m pip install --upgrade pip setuptools wheel cmake ninja numpy==1.26.1 packaging

      - name: Build ONNX Runtime and Wheel
        env:
          ROCM_PATH: /opt/rocm
          HIP_PATH: /opt/rocm/hip
          HSA_OVERRIDE_GFX_VERSION: 10.3.0
        run: |
          # We use the official python build script (tools/ci_build/build.py).
          # This replaces manual CMake commands and ensures the wheel is built 
          # with the correct version headers and dependencies.
          
          python tools/ci_build/build.py \
            --config Release \
            --build_dir build \
            --skip_submodule_sync \
            --build_wheel \
            --parallel \
            --use_rocm \
            --rocm_home /opt/rocm \
            --use_migraphx \
            --cmake_extra_defines CMAKE_HIP_ARCHITECTURES=gfx90a,gfx908,gfx1030

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: onnxruntime-rocm-wheel
          # The build.py script outputs wheels to build/Release/dist
          path: build/Release/dist/*.whl
